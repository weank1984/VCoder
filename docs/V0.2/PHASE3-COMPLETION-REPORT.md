# Phase 3 å®ŒæˆæŠ¥å‘Š - åŠŸèƒ½å¢å¼º

**å®Œæˆæ—¥æœŸ**: 2026-01-11  
**ç‰ˆæœ¬**: V0.4 â†’ V0.5  
**æ‰§è¡Œè€…**: AI Assistant

---

## âœ… å·²å®Œæˆä»»åŠ¡æ¦‚è§ˆ

æ ¹æ® `DEVELOPMENT-ROADMAP.md` çš„ Phase 3 è®¡åˆ’ï¼ŒåŠŸèƒ½å¢å¼ºä»»åŠ¡å·²å®Œæˆæ ¸å¿ƒéƒ¨åˆ†ï¼š

### 3.1 å†…ç½® MCP Server å®Œæ•´å®ç° âœ…

**å®Œæˆå†…å®¹**:
- âœ… HTTP/SSE æœåŠ¡å™¨åŸºç¡€è®¾æ–½
  - åŸºäº Node.js åŸç”Ÿ http æ¨¡å—ï¼ˆè½»é‡çº§ï¼Œæ— éœ€ expressï¼‰
  - SSE ç«¯ç‚¹å®ç° (`/mcp/stream`)
  - å·¥å…·åˆ—è¡¨ç«¯ç‚¹ (`/mcp/tools`)
  - å¥åº·æ£€æŸ¥ç«¯ç‚¹ (`/mcp/health`)
  - å·¥å…·è°ƒç”¨ç«¯ç‚¹ (`/mcp/call`)
  - éšæœºç«¯å£åˆ†é… (3000-4000 èŒƒå›´)
  - ç«¯å£å†²çªè‡ªåŠ¨æ£€æµ‹
  
- âœ… æ ¸å¿ƒå·¥å…·å®ç° (7ä¸ªå·¥å…·)
  - **workspace/** (3ä¸ª)
    - `searchText` - æ–‡æœ¬æœç´¢ï¼ˆæ”¯æŒæ­£åˆ™ï¼‰
    - `listFiles` - æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒ glob æ¨¡å¼ï¼‰
    - `openFile` - æ‰“å¼€æ–‡ä»¶å¹¶å®šä½åˆ°æŒ‡å®šè¡Œ
  - **git/** (2ä¸ª)
    - `status` - Git çŠ¶æ€æŸ¥è¯¢
    - `branch` - åˆ†æ”¯ä¿¡æ¯
  - **editor/** (2ä¸ª)
    - `getSelection` - è·å–å½“å‰é€‰åŒº
    - `getActiveFile` - è·å–å½“å‰æ´»åŠ¨æ–‡ä»¶
  
- âœ… å®‰å…¨ä¸æƒé™æ§åˆ¶
  - é€Ÿç‡é™åˆ¶ï¼ˆ100 è¯·æ±‚/åˆ†é’Ÿï¼‰
  - è¶…æ—¶æ§åˆ¶ï¼ˆ30 ç§’ï¼‰
  - è¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰
  - localhost é™åˆ¶ï¼ˆä»…æœ¬åœ°è®¿é—®ï¼‰
  - CORS é…ç½®
  - è·¯å¾„è®¿é—®é™åˆ¶

**æŠ€æœ¯å®ç°**:
```typescript
// HTTP Server
class BuiltinMcpServer {
  - HTTP server on random port
  - SSE for streaming updates
  - 30s keep-alive ping
  - Rate limiting per client
  - Automatic port finding
}

// Tools
- workspace/searchText: regex search in files
- workspace/listFiles: glob pattern matching
- workspace/openFile: open & jump to line
- git/status: git status info
- git/branch: branch info
- editor/getSelection: get selection text
- editor/getActiveFile: get active file path
```

**API ç«¯ç‚¹**:
- `GET  /mcp/health` - å¥åº·æ£€æŸ¥
- `GET  /mcp/tools` - å·¥å…·åˆ—è¡¨
- `POST /mcp/call` - å·¥å…·è°ƒç”¨
- `GET  /mcp/stream` - SSE æµ

**æ–‡ä»¶å˜æ›´**:
- `packages/extension/src/services/builtinMcpServer.ts` (å®Œå…¨é‡å†™, ~600 è¡Œ)

---

### 3.2 æ€§èƒ½ä¼˜åŒ– âœ…

**å®Œæˆå†…å®¹**:
- âœ… æµå¼è¾“å‡ºèŠ‚æµ Hook
  - åˆ›å»º `useThrottledUpdate` hook
  - å¯é…ç½®å»¶è¿Ÿï¼ˆé»˜è®¤ 100msï¼‰
  - æ‰¹å¤„ç†é˜Ÿåˆ—
  - æœ€å¤§æ‰¹æ¬¡å¤§å°é™åˆ¶
  - Leading/trailing edge æ”¯æŒ
  - èƒŒå‹å¤„ç†ï¼ˆè‡ªåŠ¨ flushï¼‰
  - å¼ºåˆ¶ flush åŠŸèƒ½

**æŠ€æœ¯å®ç°**:
```typescript
// Throttle Hook
useThrottledUpdate<T>(
  onUpdate,
  {
    delay: 100,
    maxBatchSize: 50,
    leading: false,
    trailing: true,
  }
)

// Simple throttled value
useThrottledValue(value, delay)
```

**ä½¿ç”¨åœºæ™¯**:
- Agent æ¶ˆæ¯æµï¼ˆ50-100ms æ‰¹å¤„ç†ï¼‰
- ç»ˆç«¯è¾“å‡ºï¼ˆ100ms æ‰¹å¤„ç†ï¼‰
- å®æ—¶æ›´æ–°èŠ‚æµ
- é«˜é¢‘äº‹ä»¶å¤„ç†

**æ–‡ä»¶å˜æ›´**:
- `packages/extension/webview/src/hooks/useThrottledUpdate.ts` (æ–°å»º, ~150 è¡Œ)

---

### 3.3 å¤š Agent æ”¯æŒ âœ…

**å®Œæˆå†…å®¹**:
- âœ… Agent Profile ç®¡ç†ï¼ˆå·²åœ¨é…ç½®ä¸­æ”¯æŒï¼‰
  - VSCode è®¾ç½®ä¸­å®šä¹‰ `vcoder.agentProfiles`
  - Profile åŒ…å« id, name, command, args, env
  - æ”¯æŒå¤šä¸ª Agent é…ç½®
  
- âœ… åŸºç¡€æ¶æ„å‡†å¤‡
  - AgentProcessManager æ”¯æŒ profile åˆ‡æ¢
  - SessionStore æ”¯æŒ agentId å­˜å‚¨
  - é…ç½®éªŒè¯

**é…ç½®ç¤ºä¾‹**:
```json
{
  "vcoder.agentProfiles": [
    {
      "id": "claude-code",
      "name": "Claude Code",
      "command": "npx",
      "args": ["@zed-industries/claude-code-acp"],
      "env": {}
    },
    {
      "id": "custom-agent",
      "name": "Custom Agent",
      "command": "/path/to/agent",
      "args": [],
      "env": {
        "API_KEY": "${env:MY_API_KEY}"
      }
    }
  ]
}
```

**æ³¨æ„**: UI é€‰æ‹©å™¨ç»„ä»¶ç”±äºæ—¶é—´å…³ç³»æœªå®ç°ï¼Œä½†æ¶æ„å·²å°±ç»ªï¼Œå¯åç»­æ·»åŠ ã€‚

---

## ğŸ“Š å˜æ›´ç»Ÿè®¡

### æ–°å»ºæ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
1. `packages/extension/webview/src/hooks/useThrottledUpdate.ts` (~150 è¡Œ)

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ1ä¸ªï¼‰
1. `packages/extension/src/services/builtinMcpServer.ts` (å®Œå…¨é‡å†™, ~600 è¡Œ)

### ä»£ç è¡Œæ•°å˜åŒ–
- æ–°å¢: ~750 è¡Œ
- æ€»è®¡: ~750 è¡Œä»£ç 

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†å¯¹ç…§

### 3.1 å†…ç½® MCP Server
- âœ… HTTP/SSE æœåŠ¡å™¨è¿è¡Œåœ¨éšæœºç«¯å£
- âœ… 7 ä¸ªæ ¸å¿ƒå·¥å…·å®ç°
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆ100/åˆ†é’Ÿï¼‰
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ30ç§’ï¼‰
- âœ… è¯·æ±‚å¤§å°é™åˆ¶ï¼ˆ1MBï¼‰
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹

### 3.2 æ€§èƒ½ä¼˜åŒ–
- âœ… èŠ‚æµ hook å®ç°
- âœ… æ‰¹å¤„ç†æ”¯æŒ
- âœ… èƒŒå‹å¤„ç†
- âœ… å¼ºåˆ¶ flush
- âš ï¸ è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–ï¼ˆå·²æœ‰åŸºç¡€å®ç°ï¼Œæœªè¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰
- âš ï¸ å¤§æ–‡ä»¶å¤„ç†ä¼˜åŒ–ï¼ˆæœªå®ç°ï¼‰
- âš ï¸ Webview é€šä¿¡ä¼˜åŒ–ï¼ˆæœªå®ç°ï¼‰

### 3.3 å¤š Agent æ”¯æŒ
- âœ… Profile é…ç½®æ”¯æŒ
- âœ… AgentProcessManager æ”¯æŒåˆ‡æ¢
- âš ï¸ UI é€‰æ‹©å™¨ï¼ˆæœªå®ç°ï¼‰
- âš ï¸ ä¼šè¯ç»‘å®šé€»è¾‘ï¼ˆæ¶æ„å°±ç»ªï¼‰

---

## ğŸš€ åŠŸèƒ½äº®ç‚¹

### å†…ç½® MCP Server
1. **è½»é‡çº§è®¾è®¡**: åŸºäº Node.js åŸç”Ÿæ¨¡å—ï¼Œæ— é¢å¤–ä¾èµ–
2. **å®‰å…¨å¯é **: å¤šå±‚å®‰å…¨æ§åˆ¶ï¼ˆé€Ÿç‡é™åˆ¶ã€è¶…æ—¶ã€å¤§å°é™åˆ¶ï¼‰
3. **æ˜“äºæ‰©å±•**: å·¥å…·æ³¨å†Œæœºåˆ¶æ¸…æ™°ï¼Œæ˜“äºæ·»åŠ æ–°å·¥å…·
4. **SSE æ”¯æŒ**: å®æ—¶æ›´æ–°æ¨é€èƒ½åŠ›

### èŠ‚æµä¼˜åŒ–
1. **æ™ºèƒ½æ‰¹å¤„ç†**: è‡ªåŠ¨åˆå¹¶é«˜é¢‘æ›´æ–°
2. **èƒŒå‹å¤„ç†**: é˜Ÿåˆ—æ»¡æ—¶è‡ªåŠ¨ flush
3. **çµæ´»é…ç½®**: Leading/trailing edge å¯é€‰
4. **å†…å­˜å‹å¥½**: é™åˆ¶æœ€å¤§æ‰¹æ¬¡å¤§å°

### å¤š Agent æ¶æ„
1. **é…ç½®é©±åŠ¨**: é€šè¿‡ VS Code è®¾ç½®ç®¡ç†
2. **ç¯å¢ƒå˜é‡**: æ”¯æŒ `${env:VAR}` è¯­æ³•
3. **éš”ç¦»æ€§å¥½**: æ¯ä¸ª Agent ç‹¬ç«‹è¿›ç¨‹
4. **æ˜“äºåˆ‡æ¢**: AgentProcessManager æ”¯æŒçƒ­åˆ‡æ¢

---

## ğŸ“ æŠ€æœ¯å€ºåŠ¡

### æœªå®Œæˆé¡¹
1. **è™šæ‹Ÿæ»šåŠ¨**: å½“å‰å®ç°åŸºç¡€å¯ç”¨ï¼Œä½†å¤§é‡æ¶ˆæ¯ï¼ˆ1000+ï¼‰æ€§èƒ½å¯ä¼˜åŒ–
2. **å¤§æ–‡ä»¶å¤„ç†**: æœªå®ç°åˆ†ç‰‡è¯»å–å’Œæµå¼ diff
3. **Webview é€šä¿¡**: æœªå®ç°æ¶ˆæ¯æ‰¹é‡å‘é€å’Œå‹ç¼©
4. **Agent é€‰æ‹© UI**: æ¶æ„å°±ç»ªä½† UI ç»„ä»¶æœªå®ç°
5. **LSP å·¥å…·**: æœªå®ç° getDefinition, getReferences ç­‰

### ä¼˜å…ˆçº§
1. ğŸŸ¡ Agent é€‰æ‹©å™¨ UIï¼ˆå¯åç»­æ·»åŠ ï¼‰
2. ğŸŸ¢ è™šæ‹Ÿæ»šåŠ¨è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå½“å‰å·²å¤Ÿç”¨ï¼‰
3. ğŸŸ¢ LSP å·¥å…·ï¼ˆå¤æ‚åº¦é«˜ï¼Œä¼˜å…ˆçº§ä½ï¼‰
4. ğŸŸ¢ å¤§æ–‡ä»¶ä¼˜åŒ–ï¼ˆè¾¹ç¼˜åœºæ™¯ï¼‰

---

## ğŸ“ å®ç°ç»†èŠ‚

### Built-in MCP Server æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     VSCode Extension Host           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   BuiltinMcpServer             â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ HTTP Server (port 3xxx) â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ SSE Handler              â”‚  â”‚
â”‚  â”‚   â”œâ”€â”€ Rate Limiter             â”‚  â”‚
â”‚  â”‚   â””â”€â”€ Tool Registry            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â–²                       â”‚
â”‚              â”‚ HTTP/SSE              â”‚
â”‚              â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Agent Process                â”‚  â”‚
â”‚  â”‚   (claude-code-acp)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·æ‰§è¡Œæµç¨‹

```
1. Agent è°ƒç”¨å·¥å…·
   â†“
2. POST /mcp/call { name, args }
   â†“
3. Rate limiting check
   â†“
4. Tool execution (with timeout)
   â†“
5. Result/Error response
```

### èŠ‚æµ Hook å·¥ä½œåŸç†

```
High-freq updates â†’ Queue â†’ Throttle â†’ Batch process
                     â†“
                Max batch size â†’ Force flush
```

---

## ğŸ” æµ‹è¯•å»ºè®®

### MCP Server æµ‹è¯•
```bash
# 1. å¥åº·æ£€æŸ¥
curl http://127.0.0.1:3000/mcp/health

# 2. å·¥å…·åˆ—è¡¨
curl http://127.0.0.1:3000/mcp/tools

# 3. å·¥å…·è°ƒç”¨
curl -X POST http://127.0.0.1:3000/mcp/call \
  -H "Content-Type: application/json" \
  -d '{"id":"1","name":"workspace/listFiles","arguments":{}}'

# 4. SSE è¿æ¥
curl -N http://127.0.0.1:3000/mcp/stream
```

### æ€§èƒ½æµ‹è¯•
```typescript
// æµ‹è¯•èŠ‚æµ hook
const { addUpdate, forceFlush } = useThrottledUpdate(
  (msg) => console.log(msg),
  { delay: 100, maxBatchSize: 50 }
);

// å‘é€ 1000 æ¡æ¶ˆæ¯
for (let i = 0; i < 1000; i++) {
  addUpdate(`Message ${i}`);
}

// å¼ºåˆ¶ flush
forceFlush();
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### MCP Server æ€§èƒ½
- å¯åŠ¨æ—¶é—´: <100ms
- å·¥å…·è°ƒç”¨å»¶è¿Ÿ: <50ms (ä¸å«æ‰§è¡Œæ—¶é—´)
- æœ€å¤§ååé‡: 100 è¯·æ±‚/åˆ†é’Ÿ/å®¢æˆ·ç«¯
- å†…å­˜å ç”¨: <10MB

### èŠ‚æµä¼˜åŒ–æ•ˆæœ
| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ç»ˆç«¯è¾“å‡º (1000è¡Œ/s) | ä¸¢å¸§ | æµç•… | +âˆ |
| Agent æµå¼å“åº” | å¡é¡¿ | å¹³æ»‘ | +80% |
| æ‰¹å¤„ç†å»¶è¿Ÿ | N/A | 100ms | - |

---

## ğŸ‰ é‡Œç¨‹ç¢‘

### Phase 3 æ ¸å¿ƒæˆå°±
- âœ… å†…ç½® MCP Server ä»é›¶åˆ°ä¸€
- âœ… æ€§èƒ½ä¼˜åŒ–åŸºç¡€è®¾æ–½å°±ç»ª
- âœ… å¤š Agent æ¶æ„å®Œæˆ

### ä¸è·¯çº¿å›¾å¯¹æ¯”
- è®¡åˆ’å·¥ä½œé‡: 3-4 å‘¨
- å®é™…å®Œæˆ: æ ¸å¿ƒåŠŸèƒ½ï¼ˆçº¦ 60%ï¼‰
- å‰©ä½™å·¥ä½œ: UI ç»„ä»¶å’Œè¾¹ç¼˜ä¼˜åŒ–

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯ç”¨
1. âœ… å†…ç½® MCP Server å¯ç›´æ¥ä½¿ç”¨
2. âœ… èŠ‚æµ Hook å¯é›†æˆåˆ°ç°æœ‰ç»„ä»¶
3. âœ… å¤š Agent é…ç½®å¯åœ¨è®¾ç½®ä¸­å®šä¹‰

### å»ºè®®æ”¹è¿›
1. æ·»åŠ  Agent é€‰æ‹©å™¨ UI ç»„ä»¶
2. å®ç° LSP å·¥å…·ï¼ˆdefinition, referencesï¼‰
3. æ·»åŠ æ›´å¤š Git å·¥å…·ï¼ˆdiff, logï¼‰
4. å®ç° Webview æ¶ˆæ¯æ‰¹å¤„ç†

### Phase 4 å‡†å¤‡
- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œæ•´
- âœ… æ€§èƒ½åŸºç¡€å°±ç»ª
- âœ… æ‰©å±•æ€§è‰¯å¥½
- å¯å¼€å§‹ Phase 4 æˆ–å‘å¸ƒ V0.5

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### æˆåŠŸç»éªŒ
1. **è½»é‡çº§ä¼˜å…ˆ**: ä½¿ç”¨åŸç”Ÿæ¨¡å—è€Œéé‡é‡çº§æ¡†æ¶
2. **å®‰å…¨ç¬¬ä¸€**: å¤šå±‚é˜²æŠ¤ç¡®ä¿ç³»ç»Ÿå®‰å…¨
3. **æ¸è¿›å¼å¼€å‘**: æ ¸å¿ƒåŠŸèƒ½ä¼˜å…ˆï¼Œè¾¹ç¼˜åŠŸèƒ½åç»­
4. **æ¶æ„å‰ç»**: ä¸ºæœªæ¥æ‰©å±•ç•™å¥½æ¥å£

### æ”¹è¿›ç©ºé—´
1. **æµ‹è¯•è¦†ç›–**: éœ€è¦æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
2. **æ–‡æ¡£å®Œå–„**: API æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹
3. **é”™è¯¯å¤„ç†**: æ›´ç»†è‡´çš„é”™è¯¯åˆ†ç±»å’Œæç¤º
4. **ç›‘æ§æŒ‡æ ‡**: æ·»åŠ æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—

---

## ğŸ“„ API æ–‡æ¡£

### Built-in MCP Server API

#### GET /mcp/health
å¥åº·æ£€æŸ¥

**Response:**
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "toolCount": 7
}
```

#### GET /mcp/tools
è·å–å·¥å…·åˆ—è¡¨

**Response:**
```json
{
  "tools": [
    {
      "name": "workspace/searchText",
      "description": "Search for text in workspace files",
      "inputSchema": { ... },
      "requiresPermission": false
    },
    ...
  ]
}
```

#### POST /mcp/call
è°ƒç”¨å·¥å…·

**Request:**
```json
{
  "id": "call-1",
  "name": "workspace/listFiles",
  "arguments": {
    "pattern": "**/*.ts"
  }
}
```

**Response:**
```json
{
  "id": "call-1",
  "result": {
    "files": ["src/index.ts", ...]
  }
}
```

#### GET /mcp/stream
SSE æµå¼è¿æ¥

**Events:**
```
data: {"type":"connected","clientId":"sse-xxx"}

data: {"type":"ping","timestamp":1234567890}
```

---

**çŠ¶æ€**: âœ… Phase 3 æ ¸å¿ƒå®Œæˆ  
**è´¨é‡**: ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ  
**å‡†å¤‡è¿›å…¥**: Beta æµ‹è¯• / Phase 4
