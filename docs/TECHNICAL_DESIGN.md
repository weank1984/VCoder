# VCoder - æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡æ–‡æ¡£

> åŸºäº CLI Agent çš„ VSCode æ™ºèƒ½ç¼–ç¨‹åŠ©æ‰‹æ’ä»¶ï¼ˆæ”¯æŒ Claude Codeã€Codex CLIï¼‰

**ç‰ˆæœ¬**: v0.1.0  
**æ—¥æœŸ**: 2026-01-01  
**çŠ¶æ€**: è‰ç¨¿  

---

## 1. æŠ€æœ¯æ¶æ„æ¦‚è¿°

### 1.1 æ•´ä½“æ¶æ„

VCoder é‡‡ç”¨ **Client-Server åˆ†ç¦»æ¶æ„**ï¼Œæ ¸å¿ƒç†å¿µæ˜¯å°† CLI Agentï¼ˆå¦‚ Claude Codeã€Codex CLIï¼‰ä½œä¸ºåå°è¿è¡Œï¼Œå‰ç«¯ VSCode æ’ä»¶é€šè¿‡ç»Ÿä¸€çš„ ACP åè®®è¿›è¡Œé€šä¿¡ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          VSCode Extension (Client)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        Extension Host                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ ChatProvider â”‚  â”‚ DiffProvider â”‚  â”‚ FileDecorator      â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ (Webview)    â”‚  â”‚              â”‚  â”‚                    â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚                           â–¼                                     â”‚   â”‚
â”‚  â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚   â”‚
â”‚  â”‚                  â”‚   ACPClient    â”‚                            â”‚   â”‚
â”‚  â”‚                  â”‚  (JSON-RPC)    â”‚                            â”‚   â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ stdio (stdin/stdout)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              â–¼                         Agent Server     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      CLI Adapter (æŠ½è±¡å±‚)                        â”‚  â”‚
â”‚  â”‚  â€¢ ç»Ÿä¸€æ¥å£ï¼šprompt / acceptChange / rejectChange                â”‚  â”‚
â”‚  â”‚  â€¢ è¾“å‡ºè§£æï¼šå°†ä¸åŒ CLI è¾“å‡ºè½¬æ¢ä¸ºç»Ÿä¸€çš„ ACP æ¶ˆæ¯               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                  â”‚                           â”‚
â”‚                         â–¼                  â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ClaudeCodeWrapper     â”‚  â”‚ CodexCliWrapper (æœªæ¥)        â”‚  â”‚
â”‚  â”‚ (MVP)                 â”‚  â”‚                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                              â”‚                           â”‚
â”‚              â–¼                              â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Claude Code CLI       â”‚  â”‚ OpenAI Codex CLI              â”‚  â”‚
â”‚  â”‚ (@anthropic-ai)       â”‚  â”‚ (@openai/codex)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯é€‰å‹

| å±‚çº§ | æŠ€æœ¯é€‰æ‹© | ç†ç”± |
|------|---------|------|
| Extension Host | TypeScript | VSCode Extension åŸç”Ÿè¯­è¨€ |
| UI (Webview) | React + TypeScript | ç»„ä»¶åŒ–å¼€å‘ï¼Œç”Ÿæ€ä¸°å¯Œ |
| çŠ¶æ€ç®¡ç† | Zustand | è½»é‡çº§ï¼Œæ— æ ·æ¿ä»£ç  |
| é€šä¿¡åè®® | ACP over JSON-RPC 2.0 | æ ‡å‡†åŒ– Agent é€šä¿¡åè®® |
| Agent Server | TypeScript (Node.js) | ä¸ Extension å…±äº«ç±»å‹å®šä¹‰ |

### 1.3 èŒè´£åˆ’åˆ†

| åŠŸèƒ½ | æˆ‘ä»¬å®ç° | CLI Agent å®ç° |
|------|:-------:|:---------------:|
| æ¨¡å‹è°ƒç”¨ | âŒ | âœ… |
| å·¥å…·å®šä¹‰å’Œæ‰§è¡Œ | âŒ | âœ… |
| MCP è°ƒç”¨ | âŒ | âœ… |
| æ€è€ƒè¿‡ç¨‹ç”Ÿæˆ | âŒ | âœ… |
| Token ä¸Šä¸‹æ–‡ç®¡ç† | âŒ | âœ… |
| ACP åè®®è½¬æ¢ | âœ… | âŒ |
| UI æ¸²æŸ“ | âœ… | âŒ |
| Diff é¢„è§ˆ | âœ… | âŒ |
| ç”¨æˆ·ç¡®è®¤æµç¨‹ | âœ… | âŒ |

### 1.4 å¤šåç«¯æ”¯æŒè§„åˆ’

> **è®¾è®¡åŸåˆ™**ï¼šé€šè¿‡æŠ½è±¡å±‚æ”¯æŒå¤šä¸ª CLI Agent åç«¯ï¼Œä¿æŒä¸Šå±‚ ACP åè®®ä¸å˜ã€‚

#### 1.4.1 åç«¯å¯¹æ¯”

| ç‰¹æ€§ | Claude Code CLI | Codex CLI |
|------|----------------|-----------|
| **å‚å•†** | Anthropic | OpenAI |
| **å®‰è£…** | `npm install -g @anthropic-ai/claude-code` | `npm install -g @openai/codex` |
| **éäº¤äº’æ¨¡å¼** | `-p` æ ‡å¿— | `codex exec` å‘½ä»¤ |
| **JSON è¾“å‡º** | `--output-format stream-json` | `--json` (JSONL) |
| **MCP æ”¯æŒ** | âœ… | âœ… |
| **TypeScript SDK** | éœ€è‡ªè¡ŒåŒ…è£… | âœ… `@openai/codex-sdk` |
| **çŠ¶æ€** | âœ… MVP | ğŸ“… åç»­ |

#### 1.4.2 äº‹ä»¶ç±»å‹æ˜ å°„

| ACP ç»Ÿä¸€ç±»å‹ | Claude Code äº‹ä»¶ | Codex CLI äº‹ä»¶ |
|-------------|-----------------|----------------|
| `thought` | `thinking` | `reasoning` |
| `text` | `text` | `agent_message` |
| `tool_use` | `tool_use` | `command_execution` (started) |
| `tool_result` | `tool_result` | `command_execution` (completed) |
| `file_change` | `file_write` | `file_change` |
| `mcp_call` | `mcp_tool_use` | `mcp_tool_call` |
| `task_list` | `TodoWrite` | `todo_list` |
| `complete` | è¿›ç¨‹é€€å‡º | `turn.completed` |

#### 1.4.3 å…¼å®¹æ€§è®¾è®¡

1. **ç»Ÿä¸€æ¥å£ (CliAdapter)**
   - `prompt(sessionId, message)` â†’ å¯åŠ¨ CLI å¹¶å‘é€æ¶ˆæ¯
   - `acceptChange(path)` â†’ æ¥å—æ–‡ä»¶ä¿®æ”¹
   - `rejectChange(path)` â†’ æ‹’ç»æ–‡ä»¶ä¿®æ”¹
   - `onUpdate(callback)` â†’ æ¥æ”¶æµå¼æ›´æ–°

2. **è¾“å‡ºè§£æå±‚**
   - æ¯ä¸ª CLI çš„ Wrapper è´Ÿè´£å°†å…¶ç‰¹å®šè¾“å‡ºè½¬æ¢ä¸ºç»Ÿä¸€çš„ ACP æ¶ˆæ¯
   - æ–°å¢ CLI åªéœ€å®ç°å¯¹åº”çš„ Wrapper

3. **é…ç½®åˆ‡æ¢**
   - ç”¨æˆ·å¯åœ¨è®¾ç½®ä¸­é€‰æ‹©é»˜è®¤ CLI Agent
   - æœªæ¥æ”¯æŒåœ¨å½“å‰ä¼šè¯ä¸­åˆ‡æ¢

---

## 2. æ¨¡å—è®¾è®¡

### 2.1 é¡¹ç›®ç»“æ„

```
vcoder/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ extension/           # VSCode æ’ä»¶
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ extension.ts        # å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ acp/client.ts       # ACP å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”œâ”€â”€ providers/          # Webviewã€Diffã€è£…é¥°å™¨
â”‚   â”‚   â”‚   â””â”€â”€ services/           # æœåŠ¡ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ webview/                # React Webview UI
â”‚   â”‚       â””â”€â”€ components/         # UI ç»„ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ server/              # Agent Server (Claude Code åŒ…è£…å±‚)
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ acp/                # ACP æœåŠ¡ç«¯
â”‚   â”‚       â””â”€â”€ claude/wrapper.ts   # Claude Code CLI åŒ…è£…
â”‚   â”‚
â”‚   â””â”€â”€ shared/              # å…±äº«ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ package.json             # Monorepo æ ¹é…ç½®
â””â”€â”€ turbo.json               # Turborepo é…ç½®
```

### 2.2 Webview ç»„ä»¶

| ç»„ä»¶ | èŒè´£ |
|------|------|
| `ChatBubble` | ç”¨æˆ·/AI å¯¹è¯æ°”æ³¡ |
| `ThoughtBlock` | å¯æŠ˜å çš„æ€è€ƒè¿‡ç¨‹å— |
| `ToolCallList` | å·¥å…·è°ƒç”¨åˆ—è¡¨ï¼ˆ"Finished working"ï¼‰ |
| `TaskList` | ä»»åŠ¡è®¡åˆ’åˆ—è¡¨ï¼ˆPlan Modeï¼‰ |
| `ModelSelector` | æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† |
| `PlanModeToggle` | Plan Mode åˆ‡æ¢æŒ‰é’® |
| `InputArea` | è¾“å…¥åŒºï¼ˆå«é™„ä»¶ã€@å¼•ç”¨ï¼‰ |
| `SessionHeader` | ä¼šè¯ç®¡ç†å¤´éƒ¨ |
| `SessionList` | å¤šä¼šè¯åˆ—è¡¨é¢æ¿ |
| `ConfirmDialog` | ç¡®è®¤å¼¹çª—ï¼ˆPlan/Bashæ‰§è¡Œï¼‰ |
| `ErrorBanner` | é”™è¯¯æç¤ºæ¡ |
| `ApiKeySetup` | API Key é…ç½®å‘å¯¼ |

---

## 3. ACP åè®®è®¾è®¡

### 3.1 æ ¸å¿ƒæ¶ˆæ¯ç±»å‹

| æ–¹æ³• | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| `initialize` | Client â†’ Server | åˆå§‹åŒ–è¿æ¥ï¼Œå£°æ˜èƒ½åŠ› |
| `session/new` | Client â†’ Server | åˆ›å»ºæ–°ä¼šè¯ |
| `session/list` | Client â†’ Server | è·å–ä¼šè¯åˆ—è¡¨ |
| `session/switch` | Client â†’ Server | åˆ‡æ¢å½“å‰ä¼šè¯ |
| `session/delete` | Client â†’ Server | åˆ é™¤ä¼šè¯ |
| `session/prompt` | Client â†’ Server | å‘é€ç”¨æˆ·æ¶ˆæ¯ |
| `session/update` | Server â†’ Client | æµå¼æ›´æ–° |
| `session/complete` | Server â†’ Client | ä¼šè¯å›åˆå®Œæˆ |
| `settings/change` | Client â†’ Server | åˆ‡æ¢æ¨¡å‹/æ¨¡å¼ |
| `file/accept` | Client â†’ Server | æ¥å—æ–‡ä»¶ä¿®æ”¹ |
| `file/reject` | Client â†’ Server | æ‹’ç»æ–‡ä»¶ä¿®æ”¹ |
| `bash/confirm` | Client â†’ Server | ç¡®è®¤æ‰§è¡Œ bash å‘½ä»¤ |
| `bash/skip` | Client â†’ Server | è·³è¿‡ bash å‘½ä»¤ |
| `plan/confirm` | Client â†’ Server | ç¡®è®¤æ‰§è¡Œè®¡åˆ’ |

### 3.2 æ›´æ–°ç±»å‹ (session/update)

| type | è¯´æ˜ | å…³é”®å­—æ®µ |
|------|------|---------|
| `thought` | æ€è€ƒè¿‡ç¨‹ | content, isComplete |
| `text` | æ–‡æœ¬è¾“å‡º | text |
| `tool_use` | å·¥å…·è°ƒç”¨å¼€å§‹ | id, name, input, status |
| `tool_result` | å·¥å…·è°ƒç”¨ç»“æœ | id, result, error |
| `file_change` | æ–‡ä»¶ä¿®æ”¹ | path, diff, proposed |
| `mcp_call` | MCP å·¥å…·è°ƒç”¨ | server, tool, status |
| `task_list` | ä»»åŠ¡è®¡åˆ’åˆ—è¡¨ | tasks[], currentTaskId |
| `bash_request` | Bash å‘½ä»¤ç¡®è®¤è¯·æ±‚ | command, id |
| `plan_ready` | è®¡åˆ’å®Œæˆå¾…ç¡®è®¤ | tasks[], summary |
| `error` | é”™è¯¯ä¿¡æ¯ | code, message, action |

### 3.3 é€šä¿¡æµç¨‹

```
Client                              Server                          Claude Code
  â”‚                                    â”‚                                  â”‚
  â”‚â”€â”€â”€ initialize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                  â”‚
  â”‚â—„â”€â”€ initialized â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”‚                                  â”‚
  â”‚                                    â”‚                                  â”‚
  â”‚â”€â”€â”€ session/new â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                  â”‚
  â”‚â—„â”€â”€ session/created â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”‚                                  â”‚
  â”‚                                    â”‚                                  â”‚
  â”‚â”€â”€â”€ session/prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€ spawn CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚                                    â”‚â—„â”€â”€ JSON stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
  â”‚â—„â”€â”€ session/update (thought) â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
  â”‚â—„â”€â”€ session/update (tool_use) â”€â”€â”€â”€â”€â”‚                                  â”‚
  â”‚â—„â”€â”€ session/update (tool_result) â”€â”€â”‚                                  â”‚
  â”‚â—„â”€â”€ session/update (file_change) â”€â”€â”‚                                  â”‚
  â”‚â—„â”€â”€ session/update (text) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
  â”‚â—„â”€â”€ session/complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                  â”‚
  â”‚                                    â”‚                                  â”‚
  â”‚â”€â”€â”€ file/accept â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â”€â”€â”€ confirm change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
  â”‚â—„â”€â”€ file/applied â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”‚                                  â”‚
```

---

## 4. Agent Server è®¾è®¡

### 4.1 æ ¸å¿ƒèŒè´£

Agent Server æ˜¯ Claude Code CLI çš„**åè®®é€‚é…å±‚**ï¼š

1. **è¿›ç¨‹ç®¡ç†**ï¼šå¯åŠ¨/å…³é—­ Claude Code CLI å­è¿›ç¨‹
2. **åè®®è½¬æ¢**ï¼šå°† Claude Code JSON è¾“å‡ºè½¬æ¢ä¸º ACP æ¶ˆæ¯
3. **ä¼šè¯ç®¡ç†**ï¼šç»´æŠ¤å¤šä¼šè¯çŠ¶æ€

### 4.2 Claude Code CLI åŒ…è£…å™¨ (ä¼ªä»£ç )

```
class ClaudeCodeWrapper:
  
  function prompt(sessionId, message):
    # å¯åŠ¨ Claude Code CLI å­è¿›ç¨‹
    process = spawn("claude", [
      "-p", message,
      "--output-format", "stream-json",
      "--model", currentModel
    ])
    
    # é€è¡Œè¯»å– JSON è¾“å‡º
    for each line in process.stdout:
      event = parseJSON(line)
      acpMessage = convertToACP(event)
      emit("update", sessionId, acpMessage)
    
    # å®Œæˆ
    emit("complete", sessionId)

  function convertToACP(claudeEvent):
    match claudeEvent.type:
      "thinking"    â†’ { type: "thought", content: ... }
      "text"        â†’ { type: "text", text: ... }
      "tool_use"    â†’ { type: "tool_use", id: ..., name: ..., status: ... }
      "tool_result" â†’ { type: "tool_result", id: ..., result: ... }
      "file_write"  â†’ { type: "file_change", path: ..., diff: ... }
      "mcp_tool"    â†’ { type: "mcp_call", server: ..., tool: ... }
```

---

## 5. Extension Host è®¾è®¡

### 5.1 å¯åŠ¨æµç¨‹ (ä¼ªä»£ç )

```
function activate(context):
  # 1. å¯åŠ¨ Agent Server
  serverManager = new ServerManager()
  serverManager.start()

  # 2. åˆå§‹åŒ– ACP å®¢æˆ·ç«¯
  acpClient = new ACPClient(serverManager.stdio)
  acpClient.initialize()

  # 3. æ³¨å†Œ Webview Provider
  chatProvider = new ChatViewProvider(acpClient)
  registerWebviewViewProvider("vcoder.chatView", chatProvider)

  # 4. æ³¨å†Œæ–‡ä»¶è£…é¥°å™¨
  fileDecorator = new FileDecorator(acpClient)
  registerFileDecorationProvider(fileDecorator)

  # 5. æ³¨å†ŒçŠ¶æ€æ 
  statusBar = createStatusBarItem()
  statusBar.text = "VCoder: â— Connected"
```

### 5.2 Webview é€šä¿¡ (ä¼ªä»£ç )

```
class ChatViewProvider:
  
  function resolveWebviewView(webview):
    # è®¾ç½® Webview HTML
    webview.html = loadReactApp()
    
    # ç›‘å¬æ¥è‡ª Webview çš„æ¶ˆæ¯
    webview.onMessage(message):
      match message.type:
        "send"         â†’ acpClient.prompt(sessionId, message.content)
        "acceptChange" â†’ acpClient.acceptFileChange(message.path)
        "rejectChange" â†’ acpClient.rejectFileChange(message.path)
        "setModel"     â†’ acpClient.changeSettings({ model: message.model })
        "setPlanMode"  â†’ acpClient.changeSettings({ planMode: message.enabled })
    
    # å°† ACP æ›´æ–°è½¬å‘ç»™ Webview
    acpClient.on("session/update", data):
      webview.postMessage({ type: "update", data })
```

---

## 6. æ„å»ºä¸éƒ¨ç½²

### 6.1 å¼€å‘å‘½ä»¤

| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `pnpm install` | å®‰è£…ä¾èµ– |
| `pnpm build` | å¹¶è¡Œæ„å»ºæ‰€æœ‰åŒ… |
| `pnpm dev` | å¼€å‘æ¨¡å¼ï¼ˆç›‘å¬å˜æ›´ï¼‰ |
| `vsce package` | æ‰“åŒ… VSIX |
| `vsce publish` | å‘å¸ƒåˆ° Marketplace |

### 6.2 ä¾èµ–æ¡ä»¶

| ä¾èµ–é¡¹ | ç‰ˆæœ¬è¦æ±‚ |
|--------|---------|
| Node.js | â‰¥ 18.0.0 |
| VSCode | â‰¥ 1.80.0 |
| Claude Code CLI | æœ€æ–°ç‰ˆ |

---

## 7. å®‰å…¨è€ƒé‡

| å®‰å…¨ç‚¹ | æªæ–½ |
|--------|------|
| API Key å­˜å‚¨ | ä½¿ç”¨ VSCode Secret Storage API |
| å‘½ä»¤æ‰§è¡Œ | æ–‡ä»¶å†™å…¥éœ€ç”¨æˆ·ç¡®è®¤ (Diff é¢„è§ˆ) |
| å·¥å…·è®¿é—® | é™åˆ¶åœ¨ workspace èŒƒå›´å†… |

---

## 8. æµ‹è¯•ç­–ç•¥

| æµ‹è¯•ç±»å‹ | è¦†ç›–èŒƒå›´ |
|---------|---------|
| å•å…ƒæµ‹è¯• | ACP æ¶ˆæ¯åºåˆ—åŒ–ã€åè®®è½¬æ¢ |
| é›†æˆæµ‹è¯• | Extension æ¿€æ´»ã€æœåŠ¡å¯åŠ¨ |
| æ‰‹åŠ¨æµ‹è¯• | å¯¹è¯æµç¨‹ã€Diff é¢„è§ˆã€æ–‡ä»¶æ“ä½œ |

---

## 9. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| Claude Code CLI æ›´æ–°ä¸å…¼å®¹ | é«˜ | å°è£…éš”ç¦»å±‚ï¼Œé”å®šç‰ˆæœ¬ |
| ACP åè®®å°šæœªç¨³å®š | ä¸­ | è®¾è®¡æŠ½è±¡å±‚ï¼Œä¾¿äºå‡çº§ |
| é•¿æ—¶é—´è¿è¡Œå†…å­˜æ³„æ¼ | ä¸­ | ç›‘æ§å†…å­˜ï¼Œå®šæœŸé‡å¯ |

---

## é™„å½•

### å‚è€ƒèµ„æ–™

- [ACP åè®®è§„èŒƒ](https://agentclientprotocol.com)
- [VSCode Extension Guide](https://code.visualstudio.com/api)
- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/claude-code)

### æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| ACP | Agent Client Protocolï¼ŒAI Agent ä¸ IDE é€šä¿¡åè®® |
| JSON-RPC | è½»é‡çº§è¿œç¨‹è¿‡ç¨‹è°ƒç”¨åè®® |
| MCP | Model Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®® |
