# PRD：Claude 类桌面 AI 助手复刻（Clean-Room）

## 0. 文档信息

- 文档版本：v1.0
- 创建日期：2026-02-18
- 目标读者：产品、工程、设计、测试、安全合规
- 对应技术分析：`docs/plan/claude-desktop-replica-technical-analysis.md`

## 1. 背景与目标

### 1.1 背景

我们希望复刻一款“桌面优先”的 AI 助手应用，核心体验对齐 Claude Desktop 的能力边界：

- 桌面原生入口（主窗口 + 快捷入口 + 系统托盘）
- 基于 Web UI 的会话体验（流式回复、工具调用、MCP 生态）
- 本地能力桥接（终端、文件、截图、全局快捷键、可选语音）
- 强安全边界（权限请求、域名与导航控制、上下文隔离）

### 1.2 产品目标（Must）

- 提供 macOS 首发的桌面应用，支持主窗口聊天与快速唤起输入。
- 支持 MCP server 管理与工具调用可视化。
- 支持“受控工具执行”：文件读写、终端命令、截图等能力必须可审计。
- 构建可持续演进的架构：Electron Shell + Web App + Native Bridge 分层。

### 1.3 非目标（Not in V1）

- 不复制任何闭源实现细节、私有接口、品牌资源、文案与埋点体系。
- 不复刻组织内部专有功能（如特定 Office Add-in、内网部署逻辑）。
- 不在 V1 支持所有平台特性等价（Windows/Linux 在 V1.1+ 补齐）。

## 2. 产品原则

- 清晰授权：任何敏感操作先授权后执行。
- 可解释执行：用户可查看“做了什么、何时做、为什么做”。
- 默认安全：最小权限、默认拒绝、白名单放行。
- 快速响应：交互帧率与首屏时间优先。
- Clean-room：仅基于可观察行为与通用技术栈重建，不复制代码。

## 3. 用户与核心场景

### 3.1 目标用户

- 个人开发者：本地代码协作、命令执行、快速问答。
- 技术团队：通过 MCP 集成内部工具，统一安全控制。
- 内容工作者：快速入口、截图/语音输入、跨窗口切换。

### 3.2 核心场景

1. 用户按全局快捷键唤起“Quick Entry”，输入任务后回到主窗口继续深度会话。
2. Agent 需要修改文件或执行命令时，弹出权限请求并给出风险说明。
3. 用户在设置页添加 MCP server，随后在会话中调用并查看工具执行轨迹。
4. 用户查看日志/诊断信息并导出会话审计记录用于问题排查。

## 4. 版本范围（V1）

### 4.1 功能清单

- Shell
- 主窗口（BrowserWindow + BrowserView）
- Quick Entry 小窗
- 系统托盘与菜单
- 深链协议（`ourapp://`）
- Web 会话层
- 流式聊天
- 工具调用时间线
- MCP server 配置与状态
- Native 能力层
- 全局快捷键
- 屏幕截图（受权限控制）
- 终端命令执行（受权限控制）
- 安全与治理
- 导航白名单
- `contextIsolation` + preload bridge
- 权限策略与审计日志

### 4.2 可延期项（V1.1+）

- 语音听写
- 轻量虚拟化/沙箱执行
- 扩展商店
- 企业策略中心与 SSO 深度整合

## 5. 功能需求（FR）

### 5.1 桌面壳

- FR-001：支持单实例启动；重复启动聚焦主窗口。
- FR-002：主窗口支持最小化到托盘，用户可配置关闭行为。
- FR-003：支持全局快捷键打开 Quick Entry。
- FR-004：支持深链协议拉起并路由到指定页面。

### 5.2 会话体验

- FR-101：支持 token 级流式输出，首字延迟可观测。
- FR-102：支持工具调用卡片（开始/进行中/完成/失败）。
- FR-103：支持会话内附件（文本文件优先）。
- FR-104：支持会话搜索与历史回溯。

### 5.3 工具与 MCP

- FR-201：支持配置本地/远端 MCP server（stdio/http/sse 至少二选一）。
- FR-202：展示 MCP server 在线状态与最近错误。
- FR-203：工具调用前执行权限检查策略。
- FR-204：工具输出支持结构化展示与原始日志查看。

### 5.4 权限与安全

- FR-301：对文件写入、终端执行、截图等敏感能力进行逐次授权。
- FR-302：支持“本次允许 / 会话允许 / 永久拒绝”三档策略。
- FR-303：渲染进程禁用 Node 直连；仅通过 preload 白名单 API 调用。
- FR-304：外部导航默认阻止，仅允许白名单域名/协议。

### 5.5 可观测性

- FR-401：记录关键事件（启动、崩溃、权限决策、工具调用结果）。
- FR-402：支持用户导出诊断包（脱敏）。
- FR-403：支持错误上报开关（默认开启，可关闭）。

## 6. 非功能需求（NFR）

- NFR-001 性能：冷启动到可交互 < 3 秒（M 系列 Mac 基线）。
- NFR-002 性能：主窗口滚动与输入保持 60fps 目标。
- NFR-003 稳定性：日常会话崩溃率 < 0.3%。
- NFR-004 安全：默认最小权限，权限拒绝不应导致应用崩溃。
- NFR-005 可维护性：Shell/Web/Native 分仓或分包解耦，支持独立发布。

## 7. 关键指标（KPI）

- 激活率：安装后 24 小时内创建首会话比例 > 55%。
- 会话完成率：有有效回复的会话占比 > 90%。
- 工具成功率：工具调用成功率 > 95%（剔除用户拒绝）。
- 权限体验：用户对权限弹窗“困惑反馈”< 3%。
- 稳定性：Crash-free session > 99.5%。

## 8. 里程碑计划

### M1（2-3 周）：可运行壳

- Electron 主窗口、托盘、单实例、深链、自动更新骨架。

### M2（3-4 周）：会话与工具骨架

- Web 聊天界面、流式输出、工具时间线、基础 MCP 接入。

### M3（3-4 周）：权限与本地能力

- preload 安全桥、权限中心、终端与文件能力、审计日志。

### M4（2-3 周）：质量封版

- 性能调优、崩溃治理、安装包与签名、公测文档。

## 9. 验收标准（V1 GA）

1. 用户可以完成“启动 -> 提问 -> 工具执行授权 -> 返回结果”闭环。
2. 权限拒绝路径可用，且不会导致会话卡死或应用崩溃。
3. MCP server 可配置、可连通、可调用并可追踪失败原因。
4. 主渲染面与 Quick Entry 之间可稳定切换。
5. 审计日志可导出并包含权限决策与工具调用记录。

## 10. 风险与应对

- 技术风险：原生能力跨平台差异大。
- 应对：V1 先做 macOS；Windows/Linux 走 feature flag。
- 安全风险：工具执行越权。
- 应对：默认拒绝 + 白名单 + 明确权限提示 + 审计追踪。
- 合规风险：误用品牌或复制私有实现。
- 应对：统一 clean-room 开发规范与法务检查清单。

## 11. 依赖与前置

- AI 推理 API（自有或第三方）
- MCP 协议实现或 SDK
- Electron 自动更新基础设施
- 代码签名与发布证书

## 12. 证据对齐（用于需求合理性，不用于复制代码）

- `Info.plist` 显示 Electron 壳特征与版本字段。
- `app.asar` / `.vite` 产物显示 Web 前端+preload 架构。
- 依赖清单显示 React/Vite/Tailwind、MCP SDK、Sentry、node-pty。
- `app.asar.unpacked` 显示 Native Node 模块（Swift/Rust）与终端相关能力。

