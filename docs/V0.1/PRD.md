> [Archived] 此文档为 V0.1 历史版本，仅供参考。当前需求请参见 PRD-LONG-TERM.md。

# VCoder - 产品需求文档 (PRD)

> 基于 CLI Agent 的 VSCode 智能编程助手插件（支持 Claude Code / Codex CLI）

**版本**: v0.1.0  
**日期**: 2026-01-01  
**状态**: 草稿  

---

## 1. 产品概述

### 1.1 背景

随着 AI 辅助编程工具的快速发展，开发者需要一个能够无缝集成到现有工作流中的智能编程助手。Claude Code 作为 Anthropic 推出的命令行工具，提供了强大的代码理解、生成和调试能力，但缺乏与主流 IDE 的深度集成。

### 1.2 产品定位

**VCoder** 是一款 VSCode 插件，通过 Client-Server 架构将 CLI Agent（如 Claude Code、Codex CLI）的能力无缝集成到 VSCode 中，为开发者提供：
- 实时对话式编程辅助
- 智能代码理解与生成
- 可视化的代码修改预览
- 上下文感知的文件操作
- **多后端支持**：MVP 支持 Claude Code，后续扩展支持 Codex CLI

### 1.3 目标用户

| 用户类型 | 特征 | 主要需求 |
|---------|------|---------|
| 专业开发者 | 日常使用 VSCode，熟悉 AI 工具 | 提升编码效率，减少上下文切换 |
| 技术团队 | 需要代码审查和协作 | 代码解释、重构建议 |
| 学习者 | 正在学习编程 | 代码理解、错误解释 |

---

## 2. 核心功能

### 2.1 功能优先级矩阵

| 功能 | 优先级 | MVP | 说明 |
|------|--------|-----|------|
| 对话式交互界面 | P0 | ✅ | 聊天气泡式 UI |
| Claude Code 后台服务 | P0 | ✅ | 通过 ACP 协议通信 |
| 代码 Diff 预览 | P0 | ✅ | 可视化展示代码修改 |
| **Thought 展示** | P0 | ✅ | 可折叠的 AI 思考过程 |
| **工具调用列表** | P0 | ✅ | 详细展示 Agent 操作 |
| **Plan Mode 切换** | P0 | ✅ | 规划模式/执行模式 |
| **模型选择** | P0 | ✅ | 支持多模型切换 |
| **MCP 集成** | P0 | ✅ | 支持 MCP 工具扩展 |
| **API Key 配置** | P0 | ✅ | 首次使用配置向导 |
| 文件树高亮 | P1 | ✅ | 标记受影响的文件 |
| 终端命令执行 | P1 | ✅ | 显示 AI 执行的命令 |
| **多会话管理** | P0 | ✅ | 支持多个独立对话 |
| 历史记录 | P2 | ❌ | 保存对话历史 |
| 自定义配置 | P2 | ❌ | 个性化设置 |
| **Codex CLI 支持** | P2 | ❌ | Claude Code 稳定后开发 |

### 2.2 MVP 功能详述

#### 2.2.1 对话式交互界面

**用户故事**：作为开发者，我希望在 VSCode 侧边栏中与 AI 对话，获得编程帮助。

**功能描述**：
- 侧边栏聊天面板，支持 Markdown 渲染
- 气泡式对话界面，区分用户和 AI 消息
- 支持代码块语法高亮
- 实时流式响应显示
- **@ 引用功能**：
  - 输入 `@` 弹出文件选择器
  - 支持搜索过滤文件
  - 选择文件后自动插入文件路径
  - 如有选中代码，自动附加选中内容
- 支持 📎 附件上传

**验收标准**：
- [ ] 用户可在侧边栏打开 VCoder 面板
- [ ] 支持发送文本消息并接收 AI 响应
- [ ] 响应内容以流式方式逐步显示
- [ ] 代码块正确渲染，支持复制功能
- [ ] 输入 @ 弹出文件选择器
- [ ] 选中代码后发送时自动附加代码内容
- [ ] 底部输入区包含附件、@引用功能按钮

#### 2.2.2 Claude Code 后台服务

**用户故事**：作为开发者，我希望 Claude Code 作为后台服务运行，无需切换终端。

**功能描述**：
- 插件启动时自动启动 Claude Code 服务
- 通过 ACP (Agent Client Protocol) 进行通信
- 服务状态监控与自动重连
- 支持优雅关闭

**验收标准**：
- [ ] 插件激活时自动启动后台服务
- [ ] 服务异常时显示状态提示并支持重启
- [ ] 通信稳定，消息不丢失

#### 2.2.3 代码 Diff 预览

**用户故事**：作为开发者，我希望在应用 AI 建议的代码修改前，先预览变更内容。

**功能描述**：
- 使用 VSCode 内置 Diff 编辑器展示变更
- 支持"应用"或"拒绝"操作
- 支持部分应用（按 hunk）
- 变更描述说明

**验收标准**：
- [ ] AI 修改代码时弹出 Diff 预览
- [ ] 用户可选择接受或拒绝修改
- [ ] 接受后自动保存文件

#### 2.2.4 文件树高亮

**用户故事**：作为开发者，我希望在文件资源管理器中看到 AI 操作涉及的文件。

**功能描述**：
- 使用装饰器(Decorator)标记文件状态
- 不同颜色表示：已修改(黄色)、已创建(绿色)、待删除(红色)
- 悬停显示操作详情

**验收标准**：
- [ ] 受影响文件在资源管理器中有视觉标记
- [ ] 颜色区分不同操作类型
- [ ] 操作完成后标记自动清除

#### 2.2.5 Thought 展示（思考过程）

**用户故事**：作为开发者，我希望看到 AI 的思考过程，了解它是如何分析问题的。

**功能描述**：
- 可折叠的 Thought 块，默认折叠
- 显示 AI 的推理过程和分析思路
- 点击展开查看详细内容
- 与最终回复区分显示（使用不同样式）

**验收标准**：
- [ ] AI 响应中的 Thought 以可折叠块展示
- [ ] 默认折叠状态，点击可展开
- [ ] Thought 样式与正常回复有明显区分

#### 2.2.6 工具调用列表

**用户故事**：作为开发者，我希望看到 AI 执行了哪些操作，便于追踪和调试。

**功能描述**：
- "Finished working" 可折叠块，显示工具调用总数
- 展开后显示每个工具调用的详细信息
- 状态标识：✓ 完成、⏳ 进行中、✗ 失败
- 支持查看具体参数和结果
- 错误调用高亮显示（红色）
- **特殊工具增强展示**：
  - `TodoWrite`：用于输出/更新待办清单（驱动 Task List/Plan 展示）
  - `Task`：用于启动子代理/并行执行（驱动 Task Runs 展示），不等同于 `TodoWrite`

**验收标准**：
- [ ] 显示 "Finished working" 及工具调用计数
- [ ] 可展开查看工具调用列表
- [ ] 每个工具显示名称、参数摘要、状态
- [ ] 失败的工具调用有明显的错误提示
- [ ] 每个工具支持展开查看 Input/Result（用于定位 schema 与调试）

#### 2.2.7 Plan Mode 切换

**用户故事**：作为开发者，我希望能切换 AI 的工作模式，让它在复杂任务前先规划。

**功能描述**：
- 底部输入区右侧显示模式切换按钮
- 两种模式：
  - **Plan Mode**：AI 先输出计划，等待确认后执行
  - **Execute Mode**：AI 直接执行操作
- **确认机制**：Plan Mode 下计划完成后弹出确认对话框
  - 对话框显示任务计划摘要
  - 提供"确认执行"、"修改计划"、"取消"选项
- 模式状态持久化保存

**验收标准**：
- [ ] 输入区显示当前模式状态
- [ ] 可点击切换模式
- [ ] Plan Mode 下计划完成后弹出确认对话框
- [ ] 用户确认后 AI 开始执行任务
- [ ] 模式设置在会话间保持

#### 2.2.8 Task List 展示（任务计划列表）

**用户故事**：作为开发者，我希望看到 AI 的任务计划，了解当前进度和剩余工作。

**功能描述**：
- **固定位置**：Task List 固定在 Webview 顶部（会话头部下方、消息区域上方）
- 支持折叠/展开，默认展开
- Plan Mode 激活时显示
- 实时更新任务状态（随 AI 执行进度变化）
- 支持任务状态：
  - ☐ `pending` - 待执行
  - ⏳ `in_progress` - 执行中
  - ✓ `completed` - 已完成
  - ✗ `failed` - 失败/阻塞（可选）
- **数据来源与语义区分**：
  - 计划/待办清单以 Claude Code 的 `TodoWrite` 工具输出为准（`todos[]` → Task List）
  - `Task` 工具代表“子代理/并行执行单元”，不等同于计划清单（详见 2.2.8.1）
- 支持嵌套子任务显示

**UI 示例**：
```
┌─────────────────────────────────────────────────────────┐
│ VCoder            [新对话] [会话列表 ▾]                  │ ← 会话头部
├─────────────────────────────────────────────────────────┤
│ 📋 Plan (4 tasks)                               [▼ 收起] │ ← Task List (固定)
│  ✓ 1. 分析用户认证需求                                  │
│  ⏳ 2. 设计 JWT Token 结构                              │
│  ☐ 3. 实现登录接口                                      │
│  ☐ 4. 添加中间件保护路由                                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  👤 用户消息                                            │ ← 消息区域 (滚动)
│  ...                                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**验收标准**：
- [ ] Task List 固定在消息区域上方
- [ ] 可点击折叠/展开
- [ ] Plan Mode 激活时显示，Execute Mode 隐藏
- [ ] 任务状态实时更新
- [ ] 支持嵌套子任务的缩进显示
- [ ] 若本轮未产生 `TodoWrite`，依然可通过 Task Runs 观察执行进展

##### 2.2.8.1 Task Runs 展示（子代理/并行执行）

**用户故事**：作为开发者，我希望看到 AI 在 Plan Mode 下启动了哪些子代理任务（`Task` 工具），以及它们的执行状态和输入输出，便于理解并行执行的进度与结果。

**功能描述**：
- 仅在 Plan Mode 激活时显示
- 以 `Task` 工具调用为数据源：`description / prompt / subagent_type` 等字段用于生成展示标题
- 展示每个 run 的状态（`running/completed/failed`）以及可展开的 Input/Result/Error
- **关联**：当存在 Task List（来自 `TodoWrite`）时，将 Task Runs 归属到当前 `in_progress` 的计划项（无法归属时归为 “Unassigned”）

**验收标准**：
- [ ] Plan Mode 下可看到 Task Runs 列表
- [ ] 每条 run 显示标题、子代理类型、状态
- [ ] 可展开查看 run 的 Input/Result/Error
- [ ] 可与 Task List 计划项建立可视化关联（至少显示归属/未归属）

#### 2.2.9 模型选择

**用户故事**：作为开发者，我希望能选择不同的 AI 模型，根据任务复杂度和成本权衡。

**功能描述**：
- 底部输入区显示当前模型名称
- 点击弹出可用模型列表
- 支持的模型：
  - Claude 3.5 Sonnet
  - Claude 3.5 Haiku
  - Claude 3 Opus
  - (可扩展其他模型)
- 显示模型能力/成本提示

**验收标准**：
- [ ] 显示当前使用的模型
- [ ] 可切换不同模型
- [ ] 切换后新消息使用新模型
- [ ] 模型选择保存为用户偏好

#### 2.2.10 MCP 集成

**用户故事**：作为开发者，我希望 AI 能访问更多工具和数据源，扩展其能力。

**功能描述**：
- 支持 Model Context Protocol (MCP)
- 内置 MCP 工具：
  - `mcp__web-search`：网络搜索
  - `mcp__web-reader`：网页读取
  - (可扩展更多 MCP 服务)
- 工具调用在列表中清晰显示
- 支持配置自定义 MCP 服务器

**验收标准**：
- [ ] AI 可调用 MCP 工具
- [ ] MCP 调用在工具列表中正确显示
- [ ] 支持配置 MCP 服务器地址
- [ ] MCP 调用失败有明确错误提示

#### 2.2.12 API Key 配置

**用户故事**：作为开发者，我希望能方便地配置 API Key，快速开始使用。

**功能描述**：
- 首次启动时检测 API Key 是否配置
- 未配置时显示配置向导
- 支持通过 VSCode 设置或命令面板配置
- API Key 安全存储（使用 VSCode Secret Storage）

**验收标准**：
- [ ] 首次使用时自动弹出配置提示
- [ ] 可通过命令面板设置 API Key
- [ ] API Key 错误时显示明确提示
- [ ] 支持更新/重置 API Key

#### 2.2.13 Bash 命令执行确认

**用户故事**：作为开发者，我希望在 AI 执行 bash 命令前能确认，避免危险操作。

**功能描述**：
- AI 执行 bash 命令前弹出确认对话框
- 显示待执行的命令内容
- 提供"执行"、"跳过"、"取消任务"选项
- 可配置信任模式（跳过确认）

**验收标准**：
- [ ] bash 命令执行前显示确认对话框
- [ ] 对话框显示完整命令内容
- [ ] 用户可选择执行或跳过
- [ ] 可在设置中启用信任模式

#### 2.2.14 错误状态处理

**用户故事**：作为开发者，我希望在出错时能看到清晰的提示，知道如何解决问题。

**功能描述**：
- 错误场景覆盖：
  - Claude Code CLI 未安装
  - API Key 未配置/无效
  - 网络连接失败
  - CLI 进程崩溃/超时
- 错误提示包含：
  - 错误原因
  - 解决方案建议
  - 操作按钮（如：重试、打开设置、查看文档）

**验收标准**：
- [ ] CLI 未安装时显示安装引导
- [ ] API Key 无效时提示重新配置
- [ ] 网络错误时显示重试按钮
- [ ] 进程崩溃时可一键重启服务

---

## 3. 用户体验设计

### 3.1 主要用户流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户打开 VSCode                             │
└───────────────────────────────┬─────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     VCoder 自动启动后台服务                          │
└───────────────────────────────┬─────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   用户点击侧边栏 VCoder 图标                         │
└───────────────────────────────┬─────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  用户输入问题或选中代码后发送                        │
└───────────────────────────────┬─────────────────────────────────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│               AI 响应：对话回复 / 代码修改 / 命令执行                 │
└───────────────────────────────┬─────────────────────────────────────┘
                                ▼
         ┌──────────────────────┼──────────────────────┐
         ▼                      ▼                      ▼
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│   显示回复      │   │  Diff 预览     │   │  终端输出       │
│   (气泡消息)    │   │  (接受/拒绝)   │   │  (命令结果)     │
└─────────────────┘   └─────────────────┘   └─────────────────┘
```

### 3.2 界面布局

> **VSCode 插件 UI 约束说明**：VSCode Extension 通过 Activity Bar 提供入口（仅 1 个图标），侧边栏内容通过 Webview 完全自定义。状态栏可展示简要信息。

#### 3.2.1 整体布局

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            VSCode 标题栏                                    │
├─────┬───────────────────────────────────────────┬───────────────────────────┤
│  📂 │                                           │                           │
│  🔍 │                                           │    VCoder Webview 面板    │
│  🔀 │         代码编辑器区域                     │    (完全自定义 UI)        │
│  🐛 │                                           │                           │
│  📦 │                                           │    ┌───────────────────┐  │
│  🤖◄┼─── VCoder 入口                            │    │   聊天界面内容    │  │
│     │                                           │    │   (见下方详图)    │  │
│     │                                           │    └───────────────────┘  │
│     │                                           │                           │
├─────┴───────────────────────────────────────────┴───────────────────────────┤
│ VCoder: ● Connected                                        [状态栏区域]  │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 3.2.2 Webview 内部布局（VCoder 面板）

```
┌─────────────────────────────────────────────────────────────┐
│ VCoder            [新对话] [会话列表 ▾]         ⟳   ⚙️     │ ◄── 顶部工具栏
├─────────────────────────────────────────────────────────────┤
│ 📋 Plan (4 tasks)                              [▼ 收起]    │ ◄── Task List (固定)
│  ✓ 1. 分析用户认证需求                                      │
│  ⏳ 2. 设计 JWT Token 结构                                  │
│  ☐ 3. 实现登录接口                                          │
│  ☐ 4. 添加中间件保护路由                                    │
├─────────────────────────────────────────────────────────────┤
│ 🧩 Task Runs (2)                              [▼ 收起]      │ ◄── 子代理/并行执行 (Plan Mode)
│  ⏳ 探索项目结构和现状 (Explore)                             │
│  ✓ 分析依赖与构建方式 (Build)                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  👤 用户消息                                                │ ◄── 消息区域 (滚动)
│  请帮我实现一个用户认证功能...                              │
│                                                             │
│  ▷ ⊕ Thought (可折叠)                                      │ ◄── 思考过程
│  让我分析一下这个需求，首先需要考虑...                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ✓ Finished working                  23 tool calls ▼│   │ ◄── 工具调用
│  ├─────────────────────────────────────────────────────┤   │
│  │ ✓ 分析用户认证需求                                  │   │
│  │ ✗ mcp__web-reader (Error: timeout)                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  🤖 AI 回复                                                 │
│  ## 可行性总结                                              │
│  ✅ 推荐方案：使用 JWT + Passport.js...                     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  📎  @                                                      │ ◄── 输入工具栏
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ How can I help you today?                               │ │ ◄── 输入框
│ └─────────────────────────────────────────────────────────┘ │
│                              Plan Mode ▾   claude-3.5 ▾  ⬆ │ ◄── 模式/模型选择
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.3 界面元素说明

| 位置 | 元素 | 实现方式 | 功能 |
|------|------|---------|------|
| **VSCode Activity Bar** | 🤖 图标 | contributes.viewsContainers | VCoder 入口 |
| **VSCode 状态栏** | 连接状态 | StatusBarItem | 显示服务连接状态 |
| **Webview 顶部** | 新对话/会话列表 | React 组件 | 会话管理 |
| **Webview 顶部 (固定)** | Task List | 可折叠组件 | 任务计划列表 |
| **Webview 顶部 (固定)** | Task Runs | 可折叠组件 | 子代理/并行执行列表（`Task` 工具） |
| **Webview 对话区** | 用户消息 | React 组件 | 显示用户输入 |
| **Webview 对话区** | Thought 块 | 可折叠组件 | AI 思考过程 |
| **Webview 对话区** | Finished working | 可折叠组件 | 工具调用详情 |
| **Webview 对话区** | AI 回复 | Markdown 渲染 | AI 最终回复 |
| **Webview 底部** | 📎 @ | 工具按钮 | 附件、引用 |
| **Webview 底部** | 输入框 | 文本域 | 用户输入 |
| **Webview 底部** | Plan Mode / Model | 下拉选择 | 模式和模型切换 |

---

## 4. 技术约束

### 4.1 依赖条件

| 依赖项 | 版本要求 | 说明 |
|--------|---------|------|
| VSCode | ≥ 1.80.0 | 需要 Webview API |
| Node.js | ≥ 18.0.0 | 运行时环境 |
| Claude Code CLI | 最新版 | @anthropic-ai/claude-code |

### 4.2 平台支持

| 平台 | 支持状态 |
|------|---------|
| macOS | ✅ 完全支持 |
| Linux | ✅ 完全支持 |
| Windows | ⚠️ 需测试 |

---

## 5. 成功指标

### 5.1 MVP 阶段

| 指标 | 目标值 |
|------|--------|
| 服务启动成功率 | ≥ 99% |
| 消息响应延迟 | < 500ms (首字节) |
| 用户能完成基本对话流程 | 100% |

### 5.2 后续阶段

| 指标 | 目标值 |
|------|--------|
| 日活用户 | 待定 |
| 用户满意度 | ≥ 4.5/5 |

---

## 6. 里程碑计划

| 阶段 | 目标 | 预计时间 |
|------|------|---------|
| M1: 文档评审 | PRD + 技术方案完成评审 | Week 1 |
| M2: 核心框架 | 项目结构 + ACP 通信 | Week 2-3 |
| M3: MVP 功能 | 完成 P0 功能 | Week 4-6 |
| M4: 内测发布 | 功能测试 + Bug 修复 | Week 7 |

---

## 7. 开放问题

| 问题 | 状态 | 决策 |
|------|------|------|
| claude-code 是否原生支持 ACP Server？ | 待确认 | 可能需要自行封装 |
| 是否支持远程开发环境 (SSH/Container)？ | 待讨论 | MVP 暂不支持 |
| 许可证选择 (MIT/Apache/Proprietary)？ | 待决策 | - |

---

## 附录

### 参考资料

- [Claude Code 官方文档](https://docs.anthropic.com/claude-code)
- [Agent Client Protocol 规范](https://agentclientprotocol.com)
- [VSCode Extension API](https://code.visualstudio.com/api)
