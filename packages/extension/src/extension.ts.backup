/**
 * VCoder VSCode Extension
 * Entry point and main extension logic
 */

import * as vscode from 'vscode';
import { ACPClient } from './acp/client';
import { ChatViewProvider } from './providers/chatViewProvider';
import { ServerManager } from './services/serverManager';
import { CapabilityOrchestrator } from './services/capabilityOrchestrator';
import { BuiltinMcpServer } from './services/builtinMcpServer';
import { FileDecorationProvider } from './providers/fileDecorationProvider';
import { TerminalProvider } from './services/terminalProvider';
import { PermissionProvider } from './services/permissionProvider';
import { DiffManager } from './services/diffManager';
import { AgentProcessManager } from './services/agentProcessManager';
import { FileSystemProvider } from './services/fileSystemProvider';
import { SessionStore } from './services/sessionStore';
import { AuditLogger } from './services/auditLogger';
import type { ACPMethods, UpdateNotificationParams, SessionCompleteParams } from '@vcoder/shared';

// Declare output channel at top level
const outputChannel = vscode.window.createOutputChannel('VCoder', 'VCoder');

// Global extension state
let serverManager: ServerManager;
let acpClient: ACPClient;
let permissionProvider: PermissionProvider;
let terminalProvider: TerminalProvider;
let fileSystemProvider: FileSystemProvider;
let sessionStore: SessionStore;
let auditLogger: AuditLogger;
let builtinMcpServer: BuiltinMcpServer;
let statusBarItem: vscode.StatusBarItem;
let capabilityOrchestrator: CapabilityOrchestrator | null = null;

/**
 * Extension activation entry point
 */
export async function activate(context: vscode.ExtensionContext) {
    console.log('[VCoder] Activating extension...');
    
    // Initialize Capability Orchestrator (unified component management)
    try {
        capabilityOrchestrator = await createCapabilityOrchestrator(context);
        context.subscriptions.push({
            dispose: async () => {
                await capabilityOrchestrator.shutdown();
            }
        });
    } catch (err) {
        console.error('[VCoder] Failed to initialize capability orchestrator:', err);
        outputChannel.appendLine(`[VCoder] Warning: Capability orchestrator failed to initialize: ${err}`);
    }
    
    // Get capability instances from orchestrator
    sessionStore = capabilityOrchestrator?.getCapability('sessionStore');
    const auditLogger = capabilityOrchestrator?.getCapability('auditLogger');
    const builtinMcpServer = capabilityOrchestrator?.getCapability('builtinMcpServer');
    
    // Initialize chat view provider (dependency: permissionProvider)
    const chatViewProvider = vscode.window.createWebviewPanel(
        vscode.Uri.parse('vcoder://chat'),
        {
            enableScripts: true,
            retainContextWhenHidden: true,
        }
    );
    
    if (sessionStore) {
        permissionProvider = new PermissionProvider(chatViewProvider);
    }
    
    // Initialize file system and terminal providers
    const fileSystemProvider = new FileSystemProvider(context);
    const terminalProvider = new TerminalProvider(context);
    
    context.subscriptions.push(
        () => chatViewProvider.dispose(),
        () => fileSystemProvider.dispose(),
        () => terminalProvider.dispose(),
    );
    
    // Initialize status bar
    statusBarItem = vscode.window.createStatusBarItem(vscode.StatusBarAlignment.Right, 100);
    statusBarItem.command = 'vcoder.newChat';
    statusBarItem.tooltip = 'New Chat';
    context.subscriptions.push(statusBarItem);
    
    try {
        if (capabilityOrchestrator) {
            await capabilityOrchestrator.initialize();
        }
        
        // Initialize services when server is available
        if (builtinMcpServer) {
            serverManager = capabilityOrchestrator.getCapability('serverManager');
            permissionProvider = capabilityOrchestrator.getCapability('permissionProvider');
            terminalProvider = capabilityOrchestrator.getCapability('terminalProvider');
            fileSystemProvider = capabilityOrchestrator.getCapability('fileSystemProvider');
            
            if (serverManager) {
                await serverManager.start();
                if (serverManager.getStatus() === 'running') {
                    acpClient = new ACPClient({ stdio: serverManager });
                    acpClient.on('notification', (notification: UpdateNotificationParams) => {
                        // Forward notifications to webview
                        permissionProvider?.postMessage(notification);
                    });

                    await acpClient.initialize({
                        protocolVersion: 1, // V0.2 uses protocol version 1
                        clientInfo: {
                            name: 'vcoder-vscode',
                            version: '0.2.0',
                        },
                        clientCapabilities: {
                            // M2: Terminal capability enabled
                            terminal: true,
                            // M3: File capabilities enabled
                            fs: {
                                readTextFile: true,
                                writeTextFile: true,
                            },
                        },
                        capabilities: {
                            streaming: true,
                            diffPreview: true,
                            thought: true,
                            toolCallList: true,
                            taskList: true,
                            multiSession: true,
                        },
                        workspaceFolders: vscode.workspace.workspaceFolders?.map(f => f.uri.fsPath) || [],
                    });
                }
            }
        }
        
        // Initialize diff manager and file decoration provider
        const diffManager = new DiffManager(acpClient);
        const fileDecorator = new VCoderFileDecorationProvider();
        context.subscriptions.push(
            vscode.window.registerFileDecorationProvider(fileDecorator)
        );
        
        // Register other providers
        context.subscriptions.push(diffManager.register());
        context.subscriptions.push(permissionProvider);
        
        console.log('[VCoder] Extension initialized successfully');
        
    } catch (err) {
        console.error('[VCoder] Failed to initialize extension:', err);
    }
}

/**
 * Extension deactivation
 */
export async function deactivate() {
    console.log('[VCoder] Deactivating extension...');
    
    if (capabilityOrchestrator) {
        await capabilityOrchestrator.shutdown();
    }
}